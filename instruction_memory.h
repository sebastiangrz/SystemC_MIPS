#include "systemc.h"

SC_MODULE(instruction_memory)
{
    //ports
    sc_in<sc_lv<32>> read_address;
    sc_out<sc_lv<32>> instruction, last_instr_address;

    //memory array
    sc_lv<32> data_mem[32] = {  
                "00000000000000000000000000000000", // initialize data memory
                "00000000000000000000000000000000", // mem 1
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000", 
                "00000000000000000000000000000000", // mem 10 
                "00000000000000000000000000000000", 
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",  
                "00000000000000000000000000000000", // mem 20
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000", 
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000",
                "00000000000000000000000000000000", 
                "00000000000000000000000000000000", // mem 30
                "00000000000000000000000000000000"
                };



    SC_CTOR(instruction_memory)
    {
        SC_METHOD(memory);

        SC_METHOD(ignore);
        sensitive << read_address;
    }

    void memory()
    {
        ifstream file_pointer;
        file_pointer.open("instructions.txt");

        int i = 0;

        while(file_pointer.eof())
        {
            std::string currentLine;
            getline(file_pointer, currentLine);

            for(int j = 0; j < 32; j++)
            {
                data_mem[i][31-j] = currentLine[j];
            }
            i++;
        }

        if(i > 0)
            last_instr_address.write((i-1) * 4);
        else
            last_instr_address.write("00000000000000000000000000000000");
        
        file_pointer.close();
    }

    void ignore()
    {
        instruction.write(data_mem[read_address.read().range(31, 2).to_uint()]);
    }
};